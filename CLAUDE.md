#　あなたへの指示
## 必須思考ルール
1. **曖昧さの排除**: ユーザーの質問に対して90%以上の自信を持って回答する、自信がない場合はweb検索を行い、90%以上の自信を持って回答する。90%の自信が持てない場合はユーザーに不明点を質問する
2. **確実性最優先**: 時間効率よりも確実性を常に優先する
   1. 急いで作業せずに、本質を理解して作業する
   2. 本質に対して、正しい作業を実施する
   3. 本質に対して、影響範囲を小さく修正する
3. **タスク厳守**: 指定されたタスク以外の作業は絶対に行わない
   1. ユーザーから作業範囲はシンプルにし、指示以外の作業をしないこと
   2. 指示以外の作業が必要な場合はユーザーに報告し、別で作業する
4. **指示厳守**: ユーザー指示を守る
   1. ユーザーの指示を必ず守る
   2. ユーザーの指示以外の作業をする場合は手を止めて、ユーザーに質問する(git commitや、誤字修正等のリファクタなどの優しさも含む)

## 言語とコミュニケーション
- 英語で思考し、日本語で回答する
- 簡潔で明確な表現を心がける
- 技術用語は適切に使用する

## セキュリティチェック（実装時に必須で確認する）
- [ ] フルパス（個人情報）の削除
- [ ] APIキー・トークンの確認
- [ ] パスワードのハードコーディング確認
- [ ] 機密ファイルの取り扱い確認
- [ ] 環境変数の適切な使用確認

## ディレクトリ構造と用途
### 作成ルール
- ユーザー指示がない場合は、ディレクトリ構造を確認し、適切なディレクトリに新規で作成する
- 同一トピックのドキュメントは新規作成せずに、更新する
### ディレクトリ構造
- **docs/**: 
  - プロジェクトの仕様や設計など、長期的に参照される文書
  - 恒久的なドキュメント（仕様書、API仕様、調査資料などの基本更新を行わない資料）
- **tasks/**: 
  - 現在進行中の作業や計画。完了後は必要に応じて@docs/へ移動
  - その場限りのドキュメント（作業指示書、設計書、実装計画、TODOなどの作業ごとの資料）
- **tests/**: 
  - テスト実行のたびに更新。日付付きファイル名を推奨
  - テスト結果、テスト設計書、実行ログのみ（テストコードは各プロジェクトディレクトリ内に配置）
- **reviews/**: 
  - [YYYYMMDD-hhmm-{概要}].mdの形式で保存
  - コードレビュー、セキュリティ監査結果
- **reports/**: 
  - 調査・分析結果。再利用可能な形で整理
  - 調査結果、分析レポート
- **learning/**: 
  - 「学習記録.md」に追記形式で蓄積
  - 学習記録、技術的負債、ナレッジ
- **issues**: 
  - XXX(ディレクトリ内での連番)-[issueの概要].md
  - 課題、問題点の記録

## 外部エージェントの利用について
- 使いわけルール
  - codex は設計レビュー、実装レビューなどを実施する
  - gemini はGoogleSearchを活用した検索などを実施する

###  === Claude → codex ワークフロー設定 ===
**Claude が外部ソースを必要と判断した瞬間に下記を実行**
#### 1. ワークフロー
- ユーザーが「チャッピーに聞いて」「chatGPTに聞いて」「codexに聞いて」「レビューして」と、それに類似することを言ったら開始
- 『レビュー対象』『レビュー観点』を英語で要約し、環境変数 PROMPT に格納する。
  - 『レビュー対象』
    - ユーザー指示、仕様、依頼内容
    - Claudeが生成した成果物
      - 「Claudeが生成した成果物」を作った理由（なぜその実装をしたのかの説明）
  - 『レビュー観点』
    - 『レビュー対象』を見て、仕様以上の過剰な設計になっていないか？
    - 『レビュー対象』を見て、仕様が達成できる設計になっているか？
    - 『レビュー対象』を見て、現状のソースから逸脱した設計になっていないか？
- 以下のコマンドで codex を非対話的に呼び出す:
  ```bash
  codex exec --skip-git-repo-check --dangerously-bypass-approvals-and-sandbox "$PROMPT" < /dev/null
  ````
#### 2. codex がエラーを返す場合
- エラーを返す理由は複数あると思うが、エラー内容を都度解析し呼び出し不可能だと判断した場合に実施
  - 実行不可として全ての作業を止めてユーザーに報告
###  === Claude → Gemini CLI ワークフロー設定 ===
**Claude が外部ソースを必要と判断した瞬間に下記を実行**
#### 1. ワークフロー
- ユーザーが「geminiに聞いて」と、それに類似することを言ったら開始
- 『質問内容』を英語で設定し、環境変数 PROMPT に格納する。:$質問内容=質問内容
  - 『質問内容』
    - 条件:
    - 意図: 「<ここに知りたい開発トピック>」のベストプラクティス / 一般的手法を把握
    - 優先順: 公式ドキュメント > 標準化団体/財団 > 大手クラウド/ベンダー > 大手技術ブログ  
    - 除外: 生成AI要約のみ/掲示板の断片的情報
    - 上限: 上位 5 件
    - 期間: 2025-01-01 以降を優先（古い情報は採用理由を明記）
    出力:
    1) 要点サマリ（日本語、5〜7行）
    2) 表「Source | URL | 公開/更新日 | 主要ポイント(3)」
    3) 参考リンク（必要なら追加）
- 以下のコマンドで Gemini CLI を非対話的に呼び出す:
  ```bash
  PROMPT="$質問内容" && gemini -p "$PROMPT" < /dev/null
   ````
* Gemini には `GoogleSearch`（必要に応じて `WebFetch`）を必ず使用させ、引用付き Markdown を返させる。
#### 2. gemini cliがエラーを返す場合
- エラーを返す理由は複数あると思うが、エラー内容を都度解析し検索不可能だと判断した場合に実施
- ユーザーが「web検索して」と、それに類似することを言ったら開始
  - claude code自身で web検索 を実施して検索する。
    - その際、$PROMPT を使用して検索する
### 調査タスクの品質管理プロセス
#### 1. 初期要求の記録（必須）
- ユーザーが明示的に挙げた項目は必ずTodoWriteツールでチェックリスト化
- 例：「cursor」「kiro」「claude code」「gemini cli」など
#### 2. 調査結果の検証
- 外部ツール（Gemini CLI等）の回答を鵜呑みにしない
- 特に自己参照的な調査（例：Gemini CLIでGemini CLIを調査）は要注意
- 他ツールの一機能として言及された項目も、初期要求にあれば独立項目として扱う
#### 3. 最終成果物チェック（必須）
- 提出前に初期チェックリストと照合
- 全項目が含まれているか確認
- 不足があれば追加調査または理由を明記
#### 4. 調査の原則
- ユーザーの要求 > 外部ツールの分類
- 明示的な指定項目は必ず独立して扱う
- 「○○の一部」という回答でも、要求にあれば独立項目化

## テストツールの利用制限
### E2Eテスト実行ルール
**⚠️ 以下のテストツールは直接インストール・実行を禁止し、指定されたMCPツールのみ使用可能**

- **playwright**: ✅ Playwright MCPツールのみ使用可能
  - 🔴 **禁止**: `npm install playwright`, `npx playwright test`
  - ✅ **許可**: `mcp__playwright__*`系ツールのみ
- **cypress**: 🔴 **使用禁止**（代替: Playwright MCP）
- **puppeteer**: 🔴 **使用禁止**（代替: Playwright MCP）
- **selenium**: 🔴 **使用禁止**（代替: Playwright MCP）

### ユニットテスト実行ルール
- **Jest, Vitest等**: Docker環境内での実行必須
  - 🔴 **禁止**: ホスト環境での直接実行
  - ✅ **必須**: `docker compose run --rm app npm test`

## 🔴 CRITICAL: 絶対遵守ルール（違反時は即座に作業停止）
### Docker環境強制実行（最高優先度）
**⚠️ 警告: 以下のルールに違反した場合、再度CLAUDE.mdを確認して作業再開せよ**
1. **npm/yarn/pnpm等のパッケージマネージャー**
   - 🔴 **絶対禁止**: `npm`、`yarn`、`pnpm`コマンドの直接実行
   - ✅ **必須**: 必ずDockerコンテナ内で実行
   - 📝 **正しい実行例**: `docker compose run --rm app npm install`
2. **Node.js環境での開発**
   - 🔴 **絶対禁止**: ホスト環境でのNode.js直接実行
   - ✅ **必須**: `[@Dockerfile]`で定義されたコンテナ環境を使用
   - 📝 **確認方法**: 作業開始前に`docker compose ps`で環境確認
3. **ビルド・テスト実行**
   - 🔴 **絶対禁止**: `npm run build`、`npm test`等のホスト実行
   - ✅ **必須**: `docker compose run --rm app npm run [command]`
4. **Playwright自動テストツール**
   - 🔴 **絶対禁止**: playwrightパッケージの直接インストール（`npm install playwright`、`@playwright/test`等）
   - 🔴 **絶対禁止**: playwrightブラウザのダウンロード（`npx playwright install`）
   - 🔴 **絶対禁止**: playwright CLIの直接実行（`npx playwright test`、`playwright show-report`等）
   - 🔴 **絶対禁止**: playwright設定ファイルの手動作成（`playwright.config.ts`等）
   - ✅ **必須**: E2Eテストが必要な場合は、必ずplaywright MCPツールを使用
   - 📝 **正しい実行例**: `mcp__playwright__browser_navigate`、`mcp__playwright__browser_click`等のMCPツール使用
   - ⚠️ **理由**: ホスト環境への大量のブラウザバイナリインストール防止、セキュリティリスク回避、管理された環境での実行確保
### 違反時のペナルティ・対処法
**🚨 ルール違反を検出した場合:**
1. **即座に作業停止**: 現在の作業を中断
2. **ユーザーへ報告**: 「🔴 CRITICAL違反: [違反内容]を実行しようとしました」
   - Docker環境違反: 「Docker環境を使わずに[command]を実行しようとしました」
   - Playwright違反: 「playwrightを直接[インストール/実行]しようとしました」
3. **正しい方法の提示**: Docker環境での正しい実行方法を提示
4. **再確認要求**: ユーザーの明示的な確認後に作業再開

### 複数回「CRITICAL違反」が発生する場合
**全ての作業開始前に以下を実行:**

```bash
# 1. Docker環境の確認
docker compose ps
# 2. 正しいコンテナでの作業確認
docker compose run --rm app node --version
# 3. パッケージマネージャーの確認
docker compose run --rm app npm --version
# 4. Playwright MCPツールの利用可能確認
echo "Playwright E2EテストはPlaywright MCPツール経由でのみ実行"
```

**⚠️ これらの確認なしに作業開始は禁止**
## アクセス禁止ファイル設定
### Claude Codeアクセス制限
以下のファイル/ディレクトリへのアクセスを禁止：
#### 🔴 絶対アクセス禁止
- 環境変数ファイル: `*.env*`, `.env.*`
- 認証情報: `.ssh/`, `.aws/`, `.gcp/`, `certificates/`
- 機密設定: `secrets/`, `private-keys/`, `auth/`
#### ⚠️ 注意が必要なファイル
- ログファイル: `*.log`, `logs/`
- 一時ファイル: `temp/`, `tmp/`, `*.tmp`
- バックアップ: `*.bak`, `backups/`
